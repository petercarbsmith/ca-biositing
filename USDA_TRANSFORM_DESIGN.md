# USDA Transform Design - Data Model Mapping

**Created**: January 23, 2026 **Purpose**: Clarify what data should be in the
transformed dataset for USDA ingestion

## Current State

**API Template Output** (8 columns):

```
commodity        (string) - Commodity name from NASS API
year            (int)    - Data year
county          (string) - County name
fips            (string) - FIPS code (e.g., "06077")
statistic       (string) - Type of measurement (YIELD, PRODUCTION, etc.)
unit            (string) - Unit name (TONS, BUSHELS, ACRES, DOLLARS)
observation     (numeric)- The measured value
description     (string) - Human-readable description
```

## Target Database Tables

### 1. UsdaCensusRecord

**Purpose**: Main record linking geographic location + commodity + year
**Required Fields**:

- `geoid` ← From FIPS code
- `commodity_code` (FK) ← Map commodity name to usda_commodity.id
- `year` ← From API data
- `source_reference` (optional) ← "USDA NASS QuickStats API"
- `note` (optional) ← Metadata about the record
- `dataset_id`, `etl_run_id`, `lineage_group_id` (optional)
- `created_at`, `updated_at` ← Auto-generated by ORM

### 2. Observation

**Purpose**: Actual measurements/values with full measurement context **Required
Fields**:

- `record_id` (identifier) ← Reference to UsdaCensusRecord (or generate new ID)
- `record_type` ← "USDA_NASS" or similar marker
- `dataset_id` ← Same as parent UsdaCensusRecord
- `parameter_id` (FK) ← Map "YIELD" → parameter.id where parameter.name='YIELD'
- `value` ← From observation column
- `unit_id` (FK) ← Map "TONS" → unit.id where unit.name='TONS'
- `dimension_type_id`, `dimension_value`, `dimension_unit_id` (optional) ← For
  multidimensional data (county is one dimension)
- `note` (optional) ← "YIELD measured in TONS for San Joaquin, 2022"
- `created_at`, `updated_at` ← Auto-generated by ORM

## Transform Logic Flow

### Input

One row from API template = One measurement for one (county, commodity, year,
statistic, unit) combination

```
Example API template row:
{
  commodity: "CORN",
  year: 2022,
  county: "San Joaquin",
  fips: "06077",
  statistic: "YIELD",
  unit: "BUSHELS",
  observation: 145.3,
  description: "YIELD in BUSHELS"
}
```

### Processing Steps

**Step 1: Geographic Mapping**

```python
geoid = row['fips']  # "06077"
# Could enhance to include dataset/county info, but FIPS code is sufficient
```

**Step 2: Commodity Mapping**

```python
# Query: SELECT id FROM usda_commodity WHERE name = upper('CORN')
commodity_code = get_commodity_id(row['commodity'])  # → 42 (example)
# Uses pre-populated usda_commodity table from enhanced_commodity_mapper.py
```

**Step 3: Parameter Mapping**

```python
# Query: SELECT id FROM parameter WHERE name = upper('YIELD')
parameter_id = get_parameter_id(row['statistic'])  # → 101 (example)
# May need to create Parameter records if they don't exist
```

**Step 4: Unit Mapping**

```python
# Query: SELECT id FROM unit WHERE name = upper('BUSHELS')
unit_id = get_unit_id(row['unit'])  # → 5 (example)
# May need to create Unit records if they don't exist
```

**Step 5: Create UsdaCensusRecord**

```python
usda_record = {
  geoid: "06077",
  commodity_code: 42,
  year: 2022,
  source_reference: "USDA NASS QuickStats API",
  note: "CORN, 2022 harvest data"
}
```

**Step 6: Create Observation**

```python
observation_record = {
  record_id: f"USDA_NASS_42_06077_2022_{101}_{5}",  # Unique composite ID
  record_type: "USDA_NASS",
  dataset_id: <same as parent>,
  parameter_id: 101,
  value: 145.3,
  unit_id: 5,
  note: "YIELD in BUSHELS"
}
```

### Output

Transformed dataset has two parts:

1. **UsdaCensusRecord DataFrame** - One row per (commodity, year, geoid)
2. **Observation DataFrame** - One row per measurement (could be multiple per
   record if multiple statistics)

## Questions & Decisions Needed

### Q1: Parameter and Unit Pre-population

**Current Status**: Parameter and Unit tables exist in schema but may be empty

**Options**:

- **A)** Auto-create Parameter records for YIELD, PRODUCTION, etc. if they don't
  exist
- **B)** Manually seed Parameter and Unit tables first, transform assumes they
  exist
- **C)** Store parameter/unit as strings in note field, populate tables later

**Recommendation**: Option A (auto-create missing lookups in transform)

### Q2: Observation Record Grouping

**Question**: Should multiple statistics for same commodity create multiple
Observation records, or combine them?

**Options**:

- **A)** One Observation per measurement (YIELD, PRODUCTION separately)
- **B)** One UsdaCensusRecord per commodity with all measurements linked

**Recommendation**: Option A (follows observation pattern - one measurement per
record)

### Q3: Dimension Handling

**Question**: Should we use dimension fields for county information?

**Current**: dimension_type_id, dimension_value, dimension_unit_id are available

**Options**:

- **A)** Use dimension to encode county information
- **B)** Just use geoid field, leave dimensions empty
- **C)** Use dimensions for other structured data (commodity type subcategories,
  etc.)

**Recommendation**: Option B (FIPS/geoid is sufficient; dimensions for future
use)

### Q4: Commodity vs Resource Mapping

**Question**: UsdaCensusRecord.commodity_code is FK to usda_commodity table. How
does this relate to resource/primary_ag_product?

**Current Understanding**:

- `usda_commodity` = NASS commodity codes (populated by
  enhanced_commodity_mapper)
- `resource_usda_commodity_map` = Links user resources to USDA commodities
  (populated by enhanced_commodity_mapper)
- `UsdaCensusRecord.commodity_code` = Direct reference to usda_commodity

**Decision**: USDA ingestion uses `commodity_code` directly, doesn't
create/update resource mappings

---

## Implementation Checklist

- [ ] **CREATE Parameter/Unit tables with proper schema fields** ⚠️ PRIORITY
  - [ ] Update LinkML schema if needed (add abbreviation field to Unit)
  - [ ] Create migration with proper field definitions
  - [ ] Seed Parameter records: YIELD, PRODUCTION, AREA HARVESTED, PRICE
        RECEIVED
  - [ ] Seed Unit records: TONS, BUSHELS, ACRES, DOLLARS
- [ ] Implement transform logic:
  - [ ] Step 1: Build geoid
  - [ ] Step 2: Map commodity names to IDs
  - [ ] Step 3: Map statistic names to parameter IDs
  - [ ] Step 4: Map unit names to unit IDs
  - [ ] Step 5: Create UsdaCensusRecord records DataFrame
  - [ ] Step 6: Create Observation records DataFrame
- [ ] Implement load logic:
  - [ ] Insert UsdaCensusRecord rows
  - [ ] Insert Observation rows with FK relationships
  - [ ] Handle duplicates/conflicts gracefully
- [ ] Test with sample data

---

## Schema Additions (if needed)

If Parameter/Unit tables need initial data:

```sql
-- Add USDA-relevant parameters
INSERT INTO parameter (name, standard_unit_id, calculated, description)
VALUES
  ('YIELD', NULL, false, 'Yield per unit area'),
  ('PRODUCTION', NULL, false, 'Total production quantity'),
  ('AREA HARVESTED', NULL, false, 'Area harvested'),
  ('PRICE RECEIVED', NULL, false, 'Price received by farmer');

-- Add USDA-relevant units
INSERT INTO unit (name, description)
VALUES
  ('BUSHELS', 'US bushels'),
  ('TONS', 'Short tons (US)'),
  ('ACRES', 'US acres'),
  ('DOLLARS', 'US dollars');
```
